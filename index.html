<!DOCTYPE html>
<html>
<head>
	<title>Karaoke Player</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="assets/js/midiplayer/WebAudioFontPlayer.js" ></script>
	<script src="assets/js/midiplayer/MIDIFile.js" ></script>
	<script src="assets/js/midiplayer/MIDIPlayer.js" ></script>
	<script src="assets/js/midifile/MIDIFileHeader.js" ></script>
	<script src="assets/js/KarFile.js" ></script>
	<link rel="stylesheet" href="themes/basic/theme.css" >
	<link rel="stylesheet" href="themes/sunset/theme.css" >
	<link rel="stylesheet" href="themes/christmas/theme.css" >
	<link rel="stylesheet" href="assets/css/karaoke.css" >
	<link rel="stylesheet" href="assets/css/range.css" >
	
	<link rel="shortcut icon" href="assets/images/icon.png" >
</head>
<body onload="" class="hidden" onunload="stop()">
	<div class="toolbar">
		<div class="app-title">
			<img src="assets/images/icon.png" height="32" align="absmiddle"> Karaoke Player
		</div>
		<div class="playback-toolbar">
			<input type=file id="inputfile"  accept=".mid,.midi,.kar" onchange=readKar(this) style="display:none" >
			<button type="button" onclick="document.getElementById('inputfile').click()">Open File</button>
			<button type="button" onclick="player.play()">Play</button>
			<button type="button" onclick="player.pause()">Pause</button>
			<button type="button" onclick="player.stop()">Stop</button>
			<input id="position" type="range" min="0" max="100" value="0">	
		</div>
	</div>
	
	<div id=karaoke class="player karaoke">
				<span class="previous">***</span><br>
				<span class="inactive">Karaoke </span><span class="active">Player</span><br>
				<span class="next">***</span>
	</div>
	<div id="themes" class="dialog hidden">
		<div class="dialog-content">
			<h3>Select Theme</h3>
			<div class="option basic" onclick="document.location='#basic'">
				<div class="karaoke">
					<span class="previous">Basic</span>
					<br>
					<span class="active">Basic</span>
				</div>
			</div>
			<div class="option sunset" onclick="document.location='#sunset'">
				<div class="karaoke">
					<span class="previous">Sunset</span>
					<br>
					<span class="active">Sunset</span>
				</div>
			</div>
			<div class="option christmas" onclick="document.location='#christmas'">
				<div class="karaoke">
					<span class="previous">Christmas</span>
					<br>
					<span class="active">Christmas</span>
				</div>
			</div>
		</div>
		
	</div>
	<div id="songs" class="dialog hidden">
		<div class="dialog-content" style="float: right;">
			<h3 class="list-header">Select Song</h3>
			<div id="songlist">
				<div class="Song" >Loading...</div>
			</div>
		</div>
		
	</div>
	<div id="footer" class="footer">
		<button id="themebutton" type="button" onclick="openDialog('themes')">Theme</button>
		<div id="footer-text" class="footer-text">Karaoke Player by Francisco Igor</div>
		<button id="songbutton" type="button" onclick="openDialog('songs')">Song</button>
	</div>
	<pre id=result style="display:none"></pre>
	<script src="assets/js/player.js"></script>
	<script>
	window.onload=function(){
		var pos= document.getElementById("position");
		pos.onchange=function(ev){
			console.log(pos.value);
			player.setPosition(pos.value*1);
		}
		window.onhashchange();
		player = new MIDIPlayer('inputfile');
		// creating the MidiFile instance from a buffer (view MIDIFile README)
		player.onload=function(song){
			player.play();
			pos.setAttribute("max",song.duration)
		}
		player.ontick=function(song, position){
			pos.value=position;
		}
	}
	window.onblur=function(){
		console.log("Blur", new Date())
		player.pause();
	}
	window.onfocus=function(){
		console.log("Focus", new Date())
		player.play();
	}
	window.onhashchange=function(){
		var hash=document.location.hash;
		var themes=[
			"#sunset",
			"#basic",
			"#christmas",
			"#none",
		]
		if (themes.indexOf(hash)>=0){
			document.body.className=hash.substring(1);
		}else{
			document.body.className=themes[0].substring(1);
		}
		document.getElementById("themes").className="dialog hidden";
	}
	function openDialog(id){
		var dialog=document.getElementById(id);
		console.log(dialog.className);
		if (dialog.className=="dialog hidden"){
			var dialogs=document.getElementsByClassName("dialog visible");
			if (dialogs.length) dialogs[0].className="dialog hidden";
			dialog.className="dialog visible";
		}else{
			dialog.className="dialog hidden";
		}
		
	}
	function loadSong(obj){
		playUrl(obj.playlistPath,obj.filename);
		document.getElementById("songs").className="dialog hidden";
	}
	function loadPlaylist(playlistPath){
		fetch(playlistPath+'playlist.json')
			.then(function(response) {
				return response.json();
			})
			.then(function(data) {
				console.log(data);
				var list=document.getElementById("songlist");
				list.innerHTML="";
				for(var i=0; i<data.length; i++){
					var div=document.createElement("div");
					div.innerHTML=data[i];
					div.className="song";
					div.playlistPath=playlistPath;
					div.filename=data[i];
					div.setAttribute("onclick","loadSong(this)")
					list.appendChild(div);
				}
			});
	}
	//var playlistPath='https://fraigo.github.io/kar-midi-playlists/christmas/';
	var playlistPath='assets/music/';
	loadPlaylist(playlistPath);
	
	</script>
</body>
</html>